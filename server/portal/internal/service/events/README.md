# Events Service - é‡æ„åçš„æ–‡ä»¶æ¶æ„

## æ¶æ„æ¦‚è§ˆ

äº‹ä»¶æœåŠ¡å·²é‡æ„ä¸ºæ¨¡å—åŒ–çš„æ–‡ä»¶ç»“æ„ï¼Œæ¯ä¸ªæ–‡ä»¶è´Ÿè´£ç‰¹å®šçš„åŠŸèƒ½æ¨¡å—ï¼Œæé«˜äº†ä»£ç çš„å¯è¯»æ€§å’Œå¯ç»´æŠ¤æ€§ã€‚

## æ–‡ä»¶ç»“æ„

```
events/
â”œâ”€â”€ interfaces.go          # æ‰€æœ‰æ¥å£å®šä¹‰
â”œâ”€â”€ manager_core.go        # äº‹ä»¶ç®¡ç†å™¨æ ¸å¿ƒç»“æ„å’Œé…ç½®
â”œâ”€â”€ generic_events.go      # æ³›å‹äº‹ä»¶ç›¸å…³åŠŸèƒ½
â”œâ”€â”€ converter.go           # ç±»å‹è½¬æ¢å™¨åŠŸèƒ½
â”œâ”€â”€ handlers.go            # å¤„ç†å™¨ç®¡ç†åŠŸèƒ½
â”œâ”€â”€ publisher.go           # äº‹ä»¶å‘å¸ƒåŠŸèƒ½
â”œâ”€â”€ execution.go           # äº‹ä»¶å¤„ç†æ‰§è¡ŒåŠŸèƒ½
â”œâ”€â”€ utils.go               # è¾…åŠ©å·¥å…·æ–¹æ³•
â”œâ”€â”€ types.go               # å…·ä½“äº‹ä»¶ç±»å‹å®šä¹‰
â””â”€â”€ README.md              # æ–‡æ¡£
```

## æ¨¡å—è¯´æ˜

### 1. interfaces.go - æ¥å£å®šä¹‰æ¨¡å—
**èŒè´£ï¼š** å®šä¹‰æ‰€æœ‰çš„æ¥å£å’Œå‡½æ•°ç±»å‹

**ä¸»è¦å†…å®¹ï¼š**
- `GenericEventHandler[T]` - æ³›å‹äº‹ä»¶å¤„ç†å™¨æ¥å£
- `GenericEventHandlerFunc[T]` - æ³›å‹å‡½æ•°ç±»å‹å¤„ç†å™¨
- `Event` - åŸºç¡€äº‹ä»¶æ¥å£
- `EventHandler` - ä¼ ç»Ÿäº‹ä»¶å¤„ç†å™¨æ¥å£ï¼ˆå…¼å®¹æ€§ï¼‰
- `EventHandlerFunc` - å‡½æ•°ç±»å‹å¤„ç†å™¨ï¼ˆå…¼å®¹æ€§ï¼‰
- `TypeConverter[T]` - ç±»å‹è½¬æ¢å™¨æ¥å£

### 2. manager_core.go - æ ¸å¿ƒç®¡ç†å™¨æ¨¡å—
**èŒè´£ï¼š** äº‹ä»¶ç®¡ç†å™¨çš„æ ¸å¿ƒç»“æ„å®šä¹‰å’ŒåŸºç¡€é…ç½®

**ä¸»è¦å†…å®¹ï¼š**
- `EventManager` - äº‹ä»¶ç®¡ç†å™¨ä¸»ç»“æ„ä½“
- `Config` - é…ç½®ç»“æ„ä½“
- `PublishRequest`, `GetHandlersRequest`, `ShutdownRequest` - è¯·æ±‚ç»“æ„ä½“
- `NewEventManager()` - æ„é€ å‡½æ•°
- `DefaultConfig()` - é»˜è®¤é…ç½®

### 3. generic_events.go - æ³›å‹äº‹ä»¶æ¨¡å—
**èŒè´£ï¼š** æ³›å‹äº‹ä»¶ç³»ç»Ÿçš„æ ¸å¿ƒåŠŸèƒ½

**ä¸»è¦å†…å®¹ï¼š**
- `GenericEvent[T]` - æ³›å‹äº‹ä»¶ç»“æ„ä½“
- `GenericEventRequest[T]` - æ³›å‹äº‹ä»¶å‘å¸ƒè¯·æ±‚
- `GenericConvertRequest[T]` - å¸¦è½¬æ¢å™¨çš„æ³›å‹å‘å¸ƒè¯·æ±‚
- `RegisterGenericRequest[T]` - æ³›å‹æ³¨å†Œè¯·æ±‚
- `UnregisterGenericRequest[T]` - æ³›å‹æ³¨é”€è¯·æ±‚
- `NewGenericEvent()` - åˆ›å»ºæ³›å‹äº‹ä»¶
- `PublishGeneric()` - æ³›å‹äº‹ä»¶å‘å¸ƒ
- `PublishGenericWithConverter()` - å¸¦è½¬æ¢å™¨çš„æ³›å‹äº‹ä»¶å‘å¸ƒ

### 4. converter.go - ç±»å‹è½¬æ¢å™¨æ¨¡å—
**èŒè´£ï¼š** å¤„ç†ä¸åŒæ•°æ®ç±»å‹ä¹‹é—´çš„è½¬æ¢

**ä¸»è¦å†…å®¹ï¼š**
- `DefaultTypeConverter[T]` - é»˜è®¤ç±»å‹è½¬æ¢å™¨å®ç°
- `RegisterConverter()` - æ³¨å†Œè‡ªå®šä¹‰è½¬æ¢å™¨
- `GetConverter()` - è·å–ç±»å‹è½¬æ¢å™¨

### 5. handlers.go - å¤„ç†å™¨ç®¡ç†æ¨¡å—
**èŒè´£ï¼š** äº‹ä»¶å¤„ç†å™¨çš„æ³¨å†Œã€æ³¨é”€å’Œç®¡ç†

**ä¸»è¦å†…å®¹ï¼š**
- `NamedGenericEventHandler[T]` - å¸¦åç§°çš„æ³›å‹å¤„ç†å™¨
- `NamedEventHandler` - å¸¦åç§°çš„ä¼ ç»Ÿå¤„ç†å™¨ï¼ˆå…¼å®¹æ€§ï¼‰
- `RegisterGeneric()` - æ³¨å†Œæ³›å‹å¤„ç†å™¨
- `RegisterGenericFunc()` - æ³¨å†Œæ³›å‹å‡½æ•°å¤„ç†å™¨
- `UnregisterGeneric()` - æ³¨é”€æ³›å‹å¤„ç†å™¨
- `isGenericHandlerRegistered()` - æ£€æŸ¥å¤„ç†å™¨æ˜¯å¦å·²æ³¨å†Œ

### 6. publisher.go - äº‹ä»¶å‘å¸ƒæ¨¡å—
**èŒè´£ï¼š** äº‹ä»¶çš„å‘å¸ƒå’Œåˆ†å‘é€»è¾‘

**ä¸»è¦å†…å®¹ï¼š**
- `Publish()` - ä¸»å‘å¸ƒæ–¹æ³•
- `publishGenericEvent()` - æ³›å‹äº‹ä»¶å‘å¸ƒé€»è¾‘

### 7. execution.go - äº‹ä»¶æ‰§è¡Œæ¨¡å—
**èŒè´£ï¼š** äº‹ä»¶å¤„ç†çš„å…·ä½“æ‰§è¡Œé€»è¾‘ï¼ŒåŒ…æ‹¬é‡è¯•å’Œé”™è¯¯å¤„ç†

**ä¸»è¦å†…å®¹ï¼š**
- `handleGenericEventSync()` - åŒæ­¥å¤„ç†æ³›å‹äº‹ä»¶
- `handleGenericEventAsync()` - å¼‚æ­¥å¤„ç†æ³›å‹äº‹ä»¶
- `executeGenericHandlerWithRetry()` - å¸¦é‡è¯•çš„æ³›å‹å¤„ç†å™¨æ‰§è¡Œ
- `handleEventSync()` - åŒæ­¥å¤„ç†ä¼ ç»Ÿäº‹ä»¶
- `handleEventAsync()` - å¼‚æ­¥å¤„ç†ä¼ ç»Ÿäº‹ä»¶
- `executeHandlerWithRetry()` - å¸¦é‡è¯•çš„ä¼ ç»Ÿå¤„ç†å™¨æ‰§è¡Œ

### 8. utils.go - è¾…åŠ©å·¥å…·æ¨¡å—
**èŒè´£ï¼š** æä¾›è¾…åŠ©åŠŸèƒ½å’Œç®¡ç†å™¨çš„ç”Ÿå‘½å‘¨æœŸç®¡ç†

**ä¸»è¦å†…å®¹ï¼š**
- `GetHandlers()` - è·å–å¤„ç†å™¨åˆ—è¡¨
- `GetAllEventTypes()` - è·å–æ‰€æœ‰äº‹ä»¶ç±»å‹
- `Shutdown()` - ä¼˜é›…å…³é—­äº‹ä»¶ç®¡ç†å™¨

### 9. types.go - äº‹ä»¶ç±»å‹æ¨¡å—
**èŒè´£ï¼š** å®šä¹‰å…·ä½“çš„ä¸šåŠ¡äº‹ä»¶ç±»å‹ï¼ˆä¿æŒåŸæœ‰ç»“æ„ï¼‰

**ä¸»è¦å†…å®¹ï¼š**
- è®¢å•ç›¸å…³äº‹ä»¶
- è®¾å¤‡æ“ä½œäº‹ä»¶
- ç»´æŠ¤äº‹ä»¶
- å¼¹æ€§ä¼¸ç¼©äº‹ä»¶

## ä¼˜åŠ¿

### 1. æ¨¡å—åŒ–è®¾è®¡
æ¯ä¸ªæ–‡ä»¶èŒè´£æ˜ç¡®ï¼ŒåŠŸèƒ½å†…èšï¼Œé™ä½äº†ä»£ç çš„å¤æ‚åº¦ã€‚

### 2. æ˜“äºç»´æŠ¤
- ç›¸å…³åŠŸèƒ½é›†ä¸­åœ¨åŒä¸€æ–‡ä»¶ä¸­
- æ¥å£å®šä¹‰ç»Ÿä¸€ç®¡ç†
- æ ¸å¿ƒé€»è¾‘ä¸è¾…åŠ©åŠŸèƒ½åˆ†ç¦»

### 3. æ˜“äºæ‰©å±•
- æ–°å¢äº‹ä»¶ç±»å‹å¯ä»¥ç‹¬ç«‹æ·»åŠ 
- è½¬æ¢å™¨å¯ä»¥ç‹¬ç«‹æ‰©å±•
- å¤„ç†å™¨ç®¡ç†é€»è¾‘ç‹¬ç«‹

### 4. æ›´å¥½çš„å¯æµ‹è¯•æ€§
- æ¯ä¸ªæ¨¡å—å¯ä»¥ç‹¬ç«‹æµ‹è¯•
- ä¾èµ–å…³ç³»æ›´æ¸…æ™°

## ä½¿ç”¨ç¤ºä¾‹

### åŸºæœ¬ä½¿ç”¨
```go
// åˆ›å»ºäº‹ä»¶ç®¡ç†å™¨
em := NewEventManager(logger, DefaultConfig())

// æ³¨å†Œå¤„ç†å™¨
RegisterGeneric(em, RegisterGenericRequest[OrderEvent]{
    EventType:   "order.created",
    HandlerName: "order_handler",
    Handler:     &MyOrderHandler{},
})

// å‘å¸ƒäº‹ä»¶
err := PublishGeneric(em, GenericEventRequest[OrderEvent]{
    EventType: "order.created",
    Data:      orderEvent,
    Source:    "order_service",
    Context:   ctx,
})
```

### ä½¿ç”¨ç±»å‹è½¬æ¢å™¨
```go
// æ³¨å†Œè½¬æ¢å™¨
RegisterConverter(em, &CustomOrderConverter{})

// å‘å¸ƒå¸¦è½¬æ¢çš„äº‹ä»¶
err := PublishGenericWithConverter(em, GenericConvertRequest[OrderEvent]{
    EventType: "order.created",
    RawData:   rawOrderData,
    Source:    "order_service",
    Context:   ctx,
})
```

## å…¼å®¹æ€§

é‡æ„åçš„ä»£ç å®Œå…¨å‘åå…¼å®¹ï¼ŒåŸæœ‰çš„ä½¿ç”¨æ–¹å¼ä»ç„¶æœ‰æ•ˆï¼ŒåŒæ—¶æä¾›äº†æ›´ç°ä»£åŒ–çš„æ³›å‹æ¥å£ã€‚

## æµ‹è¯•ä¸éªŒè¯

### å•å…ƒæµ‹è¯•è¦†ç›–

æœ¬é¡¹ç›®åŒ…å«å®Œæ•´çš„å•å…ƒæµ‹è¯•å¥—ä»¶ï¼Œè¦†ç›–ä»¥ä¸‹æ ¸å¿ƒåŠŸèƒ½ï¼š

#### ğŸ§ª æ ¸å¿ƒåŠŸèƒ½æµ‹è¯•
- **æ³›å‹äº‹ä»¶æ³¨å†Œå’Œå‘å¸ƒ** - éªŒè¯ç±»å‹å®‰å…¨çš„äº‹ä»¶ç³»ç»Ÿ
- **ç±»å‹è½¬æ¢å™¨** - æµ‹è¯•è‡ªåŠ¨ç±»å‹è½¬æ¢å’Œè‡ªå®šä¹‰è½¬æ¢å™¨
- **é”™è¯¯å¤„ç†æœºåˆ¶** - éªŒè¯é‡è¯•ã€è¶…æ—¶å’Œé”™è¯¯ä¼ æ’­
- **å¼‚æ­¥äº‹ä»¶å¤„ç†** - æµ‹è¯•å¹¶å‘å’Œå¼‚æ­¥å¤„ç†èƒ½åŠ›
- **å¤„ç†å™¨ç”Ÿå‘½å‘¨æœŸ** - æµ‹è¯•æ³¨å†Œã€æ³¨é”€å’Œé‡å¤æ³¨å†Œ

#### ğŸ¯ ä¸šåŠ¡åœºæ™¯æµ‹è¯•
æµ‹è¯•åŒ…å«å®Œæ•´çš„è®¢å•çŠ¶æ€å˜æ›´ä¸šåŠ¡åœºæ™¯ï¼š

```go
// åœºæ™¯1: è®¢å•å®Œæˆæµç¨‹
// device.operation.completed â†’ order.status.completed

// åœºæ™¯2: è®¢å•å–æ¶ˆæµç¨‹  
// order.status.cancelled

// åœºæ™¯3: è®¢å•é€€å›æµç¨‹
// order.status.returning â†’ device.operation.returning

// åœºæ™¯4: å¹¶å‘å¤šè®¢å•å¤„ç†
// å¤šä¸ªè®¢å•åŒæ—¶å¤„ç†ä¸åŒçŠ¶æ€å˜æ›´
```

#### ğŸ“Š æ€§èƒ½åŸºå‡†æµ‹è¯•
- **ConvertFromMap**: ~23.66 ns/op, 0 allocations
- **ConvertFromJSON**: ~642.3 ns/op, 448 B/10 allocations  
- **PublishGenericEvent**: ~5198 ns/op, 5207 B/44 allocations
- **RegisterGenericHandler**: ~2010 ns/op, 3024 B/23 allocations

### è¿è¡Œæµ‹è¯•

```bash
# è¿è¡Œæ‰€æœ‰æµ‹è¯•
go test ./server/portal/internal/service/events/ -v

# è¿è¡Œä¸šåŠ¡åœºæ™¯æµ‹è¯•
go test ./server/portal/internal/service/events/ -run "Test_OrderStatusChangeScenario" -v

# è¿è¡Œæ€§èƒ½åŸºå‡†æµ‹è¯•
go test ./server/portal/internal/service/events/ -bench=. -benchmem

# æµ‹è¯•è¦†ç›–ç‡
go test ./server/portal/internal/service/events/ -cover
```

### æµ‹è¯•ç»“æœæ‘˜è¦

âœ… **19ä¸ªæµ‹è¯•å…¨éƒ¨é€šè¿‡**
- 8ä¸ªç±»å‹è½¬æ¢å™¨æµ‹è¯•
- 10ä¸ªæ³›å‹äº‹ä»¶ç³»ç»Ÿæµ‹è¯•  
- 1ä¸ªå®Œæ•´ä¸šåŠ¡åœºæ™¯æµ‹è¯•ï¼ˆåŒ…å«4ä¸ªå­åœºæ™¯ï¼‰

ğŸ”¥ **æ ¸å¿ƒéªŒè¯ç‚¹**ï¼š
- ç±»å‹å®‰å…¨æ€§å’Œç¼–è¯‘æ—¶æ£€æŸ¥
- äº‹ä»¶çš„æ­£ç¡®å‘å¸ƒå’Œæ¥æ”¶
- é”™è¯¯å¤„ç†å’Œé‡è¯•æœºåˆ¶
- å¼‚æ­¥å¤„ç†å’Œå¹¶å‘å®‰å…¨
- ä¸šåŠ¡åœºæ™¯çš„ç«¯åˆ°ç«¯æµç¨‹

## æ¶æ„ä¼˜åŠ¿

### ä¸ä¼ ç»Ÿæ–¹æ¡ˆå¯¹æ¯”

| ç‰¹æ€§ | ä¼ ç»Ÿäº‹ä»¶ç³»ç»Ÿ | Navy-NG æ³›å‹äº‹ä»¶ç³»ç»Ÿ |
|------|-------------|-------------------|
| ç±»å‹å®‰å…¨ | âŒ | âœ… ç¼–è¯‘æ—¶æ£€æŸ¥ |
| æ€§èƒ½ | ä¸­ç­‰ | âš¡ é«˜æ€§èƒ½ |
| å¯ç»´æŠ¤æ€§ | ä½ | ğŸ”§ é«˜åº¦å¯ç»´æŠ¤ |
| æ‰©å±•æ€§ | å—é™ | ğŸš€ å®Œå…¨å¯æ‰©å±• |
| ä»£ç ç®€æ´åº¦ | å†—ä½™ | ğŸ¯ ç®€æ´ä¼˜é›… |
| æµ‹è¯•è¦†ç›– | ä¸è¶³ | âœ… å…¨é¢æµ‹è¯• |

### è§£å†³çš„æ ¸å¿ƒé—®é¢˜

1. **ç±»å‹å®‰å…¨é—®é¢˜** - é€šè¿‡æ³›å‹ç¡®ä¿ç¼–è¯‘æ—¶ç±»å‹æ£€æŸ¥
2. **ä»£ç é‡å¤é—®é¢˜** - é€šè¿‡ä¼˜é›…çš„APIè®¾è®¡å‡å°‘é‡å¤ä»£ç 
3. **æ€§èƒ½é—®é¢˜** - é€šè¿‡å¼‚æ­¥å¤„ç†å’Œå¯¹è±¡æ± ä¼˜åŒ–æ€§èƒ½
4. **æ‰©å±•æ€§é—®é¢˜** - é€šè¿‡å¯é…ç½®çš„è½¬æ¢å™¨æ”¯æŒä»»æ„æ•°æ®æ ¼å¼
5. **æµ‹è¯•éš¾åº¦é—®é¢˜** - æä¾›å®Œæ•´çš„æµ‹è¯•å·¥å…·å’Œä¸šåŠ¡åœºæ™¯éªŒè¯

---

**NavyNG æ³›å‹äº‹ä»¶ç³»ç»Ÿ - è®©äº‹ä»¶é©±åŠ¨æ¶æ„æ›´ç®€å•ã€æ›´å®‰å…¨ã€æ›´é«˜æ•ˆï¼** ğŸš€ 